# 税務書類自動リネーム・振り分けシステム 仕様書

## 1. システム概要

### 1.1 目的
税理士法人向けに、e-Tax/eLTAX/マネーフォワードからダウンロードした税務書類の自動リネーム・振り分け作業を効率化するデスクトップアプリケーション

### 1.2 基本動作フロー
1. ユーザーが通常通り複数ファイルをダウンロード
2. ダウンロード完了後、アプリで「新着ファイルをスキャン」
3. 検出ファイル一覧表示 + 自動リネーム結果をプレビュー
4. ユーザーが必要に応じてファイル名を手動修正
5. 振り分け先フォルダを選択
6. 一括でリネーム + 移動実行

## 2. 機能仕様

### 2.1 メイン画面機能

#### 2.1.1 ファイルスキャン機能
- **監視フォルダ設定**: ユーザーが指定したフォルダ（通常はダウンロードフォルダ）
- **手動スキャン**: 「新着ファイルをスキャン」ボタンクリック
- **対象ファイル**: PDF、CSV形式
- **除外条件**: 既に処理済みのファイル、システムファイル

#### 2.1.2 ファイル一覧表示
```
☑ [元ファイル名] 
   → [リネーム後ファイル名] [手動編集可能]
   書類種別: [自動判定結果] | 法人名: [抽出結果]
```

#### 2.1.3 一括操作機能
- **全選択/全解除**: チェックボックスの一括操作
- **プレビュー確認**: リネーム結果の詳細確認
- **振り分け先選択**: プルダウンメニューでクライアント/期間選択

### 2.2 自動リネーム機能

#### 2.2.1 ファイル名解析
**自動命名パターン検出**:
- `法人税及び地方法人税申告書_20240731メトロノーム株式会社_20250720130102.pdf`
- `東京都 法人都道府県民税・事業税・特別法人事業税又は地方法人特別税 確定申告書_20240731...`

**手動命名パターン検出**:
- `法人税 受信通知.pdf`
- `消費税 納付情報登録依頼.pdf`
- `固定資産台帳.pdf`

#### 2.2.2 書類種別判定
**キーワードベース判定**:
- **申告書**: 「申告書」「確定申告」
- **受信通知**: 「申告受付完了通知」「受信通知」
- **納付情報**: 「納付区分番号通知」「納付情報発行結果」
- **決算書**: 「決算報告書」「貸借対照表」「損益計算書」

#### 2.2.3 番号体系自動割当
```
0000番台: 法人税・地方法人税関連
├─ 0000: 納付税額一覧表
├─ 0001: 法人税及び地方法人税申告書
├─ 0002: 添付資料（該当時のみ）
├─ 0003: 受信通知
└─ 0004: 納付情報

1000番台: 都道府県税関連
├─ 1011: 東京都_法人都道府県民税事業税
├─ 1013: 受信通知（東京都）
├─ 1021: 愛知県_法人都道府県民税事業税
├─ 1023: 受信通知（愛知県）
├─ 1031: 福岡県_法人都道府県民税事業税
├─ 1033: 受信通知（福岡県）
└─ 1014: 納付情報（都道府県税まとめ）

2000番台: 市民税関連
├─ 2001: 愛知県蒲郡市_法人市民税
├─ 2003: 受信通知
├─ 2011: 福岡県福岡市_法人市民税
├─ 2013: 受信通知
└─ 2004: 納付情報（市民税まとめ）

3000番台: 消費税関連
├─ 3001: 消費税及び地方消費税申告書
├─ 3002: 添付資料（該当時のみ）
├─ 3003: 受信通知
└─ 3004: 納付情報

4000番台: 事業所税関連
5000番台: 決算書類関連
6000番台: 固定資産関連
7000番台: 税区分集計表関連
```

#### 2.2.4 決算期コード生成
- **算出ルール**: 事業年度終了日からYYMM形式生成
- **例**: 令和6年5月31日 → 2505（2025年5月期）
- **例**: 令和6年12月31日 → 2412（2024年12月期）

### 2.3 プレビュー・編集機能

#### 2.3.1 個別ファイル名編集
- **インライン編集**: リネーム後ファイル名をクリックで編集可能
- **リアルタイムプレビュー**: 編集中の名前をリアルタイム表示
- **バリデーション**: 不正な文字、重複ファイル名の警告

#### 2.3.2 書類種別手動変更
- **ドロップダウン選択**: 自動判定が間違った場合の手動修正
- **番号体系連動**: 書類種別変更時に番号を自動更新

#### 2.3.3 エラー・警告表示
```
⚠️ 重複ファイル名が検出されました
❌ サポートされていないファイル形式です
❓ 書類種別を判定できませんでした
```

### 2.4 振り分け機能

#### 2.4.1 振り分け先管理
**プリセット登録**:
- クライアント名 + 決算期の組み合わせ
- フォルダパスの事前登録
- よく使う振り分け先の優先表示

**複数クライアント同時処理**:
- 法人名自動抽出による自動グループ化
- クライアント別の振り分け先個別選択

#### 2.4.2 フォルダ構造作成
```
選択フォルダ/
├─ 0000番台_法人税/
├─ 1000番台_都道府県税/
├─ 2000番台_市民税/
├─ 3000番台_消費税/
├─ 4000番台_事業所税/
├─ 5000番台_決算書類/
├─ 6000番台_固定資産/
└─ 7000番台_税区分集計表/
```

### 2.5 設定画面機能

#### 2.5.1 基本設定
- **監視フォルダ**: デフォルト監視対象フォルダ設定
- **自動スキャン**: 起動時自動スキャンのON/OFF
- **バックアップ**: 元ファイル名保存設定

#### 2.5.2 クライアント管理
```
クライアント一覧:
☑ メトロノーム株式会社 2505期
   振り分け先: D:\税務書類\メトロノーム\2505期
   法人番号: 6011001128600
   [編集] [削除]

☑ エバーリッジ株式会社 2412期  
   振り分け先: D:\税務書類\エバーリッジ\2412期
   法人番号: [未設定]
   [編集] [削除]

[新規クライアント追加]
```

#### 2.5.3 リネーム規則カスタマイズ
- **番号体系**: カスタム番号ルール設定
- **命名規則**: 独自の命名パターン追加
- **除外ファイル**: 処理対象外ファイルパターン設定

## 3. 技術仕様

### 3.1 開発環境
- **フレームワーク**: Electron (クロスプラットフォーム対応)
- **バックエンド**: Node.js
- **フロントエンド**: React + TypeScript
- **データベース**: SQLite (設定・履歴管理)

### 3.2 主要ライブラリ
- **PDF解析**: pdf-parse, pdf2pic
- **ファイル操作**: fs-extra, path
- **ファイル監視**: chokidar
- **UI**: Material-UI, Electron Builder

### 3.3 パフォーマンス要件
- **起動時間**: 3秒以内
- **スキャン処理**: 100ファイル/5秒以内
- **メモリ使用量**: 100MB以下（待機時）

## 4. ユーザーインターフェース

### 4.1 メイン画面レイアウト
```
┌────────────────────────────────────────────────┐
│ [監視フォルダ: C:\Downloads          [変更]]     │
│ [新着ファイルをスキャン]  [設定]  [処理履歴]      │
├────────────────────────────────────────────────┤
│ 検出ファイル数: 8件 | 選択済み: 7件             │
│                                              │
│ ☑ 法人税及び地方法人税申告書_20240731...         │
│   → 0001_法人税及び地方法人税申告書_2505.pdf   │
│   書類種別: 法人税申告書 | 法人名: メトロノーム㈱  │
│   [📝編集]                                    │
│                                              │
│ ☑ 東京都 法人都道府県民税・事業税...              │
│   → 1011_東京都_法人都道府県民税事業税_2505.pdf │
│   書類種別: 都道府県税申告書 | 法人名: メトロノーム㈱│
│   [📝編集]                                    │
│                                              │
│ [全選択] [全解除] [プレビュー詳細]              │
│                                              │
│ 振り分け先: [メトロノーム株式会社 2505期    ▼]   │
│ または新規: [                    ] [参照...]    │
│                                              │
│ ┌──── 処理オプション ────┐                    │
│ │ ☑ 元ファイルをバックアップ保存 │                    │
│ │ ☑ 処理後に結果レポート表示   │                    │
│ │ ☑ 振り分け先フォルダを開く   │                    │
│ └─────────────────────┘                    │
│                                              │
│         [🔄 リネーム+移動 実行]              │
└────────────────────────────────────────────────┘
```

### 4.2 編集モード画面
```
┌────── ファイル名編集 ──────┐
│                               │
│ 元ファイル名:                    │
│ 法人税及び地方法人税申告書_20240731...│
│                               │
│ 新しいファイル名:                 │
│ [0001_法人税及び地方法人税申告書_2505.pdf]│
│                               │
│ 書類種別: [法人税申告書     ▼]     │
│ 決算期: [2505期           ▼]     │
│ 番号: [0001              ▼]     │
│                               │
│    [💾保存]  [❌キャンセル]      │
└───────────────────────┘
```

### 4.3 進行状況表示
```
┌──────── 処理中 ────────┐
│                           │
│ ████████████████████░░ 90% │
│                           │
│ リネーム完了: 7/8 ファイル    │
│ 移動完了: 5/8 ファイル       │
│ 残り処理時間: 約3秒         │
│                           │
│     [⏸️一時停止]          │
└───────────────────────┘
```

## 5. エラーハンドリング

### 5.1 処理エラー対応
- **ファイル移動失敗**: 「要確認」フォルダに一時保存
- **権限エラー**: 管理者権限での再実行提案
- **ディスク容量不足**: 警告表示と処理中断

### 5.2 データ保護
- **元ファイル保護**: 処理前の自動バックアップ
- **Undo機能**: 処理後24時間以内の復元機能
- **処理ログ**: 全操作の詳細ログ保存

## 6. 拡張性

### 6.1 将来対応予定
- **API連携**: マネーフォワード・申告の達人API公開時の自動対応
- **OCR機能**: スキャン画像PDFからのテキスト抽出
- **AI判定**: 機械学習による書類分類精度向上

### 6.2 プラグイン対応
- **カスタムルール**: 税理士事務所独自ルールの外部ファイル読み込み
- **外部システム連携**: 他社申告管理システムとの連携

## 7. セキュリティ

### 7.1 データ保護
- **ローカル処理**: 機密書類の外部送信なし
- **暗号化**: 設定ファイルの暗号化保存
- **アクセスログ**: 操作履歴の記録

### 7.2 権限管理
- **最小権限**: 必要最小限のシステム権限
- **ファイルアクセス**: 指定フォルダのみアクセス可能
